<section class="admin-page">
  <header class="page-header">
    <div>
      <h1>Administration</h1>
      <p>Manage venues and user access for the selected tenant.</p>
    </div>
  </header>

  @if (pageError) {
    <p class="page-error">{{ pageError }}</p>
  }

  <nav class="admin-tabs" aria-label="Admin sections">
    @for (tab of adminTabs; track tab.value) {
      <button
        type="button"
        [class.active]="adminTab === tab.value"
        (click)="setAdminTab(tab.value)">
        {{ tab.label }}
      </button>
    }
  </nav>

  @if (adminTab === 'management') {
  <section class="admin-grid">
    <article class="panel">
      <div class="panel-header">
        <div>
          <h2>Venue Management</h2>
          <p>Update core venue profile, compliance, and hold defaults.</p>
        </div>
      </div>

      <label class="field">
        <span>Venue</span>
        <select
          [ngModel]="selectedVenueId"
          [ngModelOptions]="{ standalone: true }"
          (ngModelChange)="onVenueSelectionChanged($event)"
          [disabled]="loadingVenues || venues.length === 0">
          @for (venue of venues; track venue.id) {
            <option [value]="venue.id">{{ venue.name }}</option>
          }
        </select>
      </label>

      @if (loadingVenueProfile) {
        <p class="hint">Loading venue profile...</p>
      }

      @if (venueMessage) {
        <p class="hint">{{ venueMessage }}</p>
      }

      @if (venueDraft) {
        <div class="form-grid">
          <label class="field">
            <span>Venue Name</span>
            <input type="text" [(ngModel)]="venueDraft.name" name="venueName" />
          </label>

          <label class="field">
            <span>Legal Entity Name</span>
            <input type="text" [(ngModel)]="venueDraft.legalEntityName" name="legalEntityName" />
          </label>

          <label class="field">
            <span>Enquiries Email</span>
            <input type="email" [(ngModel)]="venueDraft.enquiriesEmail" name="enquiriesEmail" />
          </label>

          <label class="field">
            <span>Phone (E.164)</span>
            <input type="text" [(ngModel)]="venueDraft.phoneNumberE164" name="phoneNumberE164" placeholder="+447700900111" />
          </label>

          <label class="field">
            <span>Website URL</span>
            <input type="url" [(ngModel)]="venueDraft.websiteUrl" name="websiteUrl" />
          </label>

          <label class="field">
            <span>VAT Number</span>
            <input type="text" [(ngModel)]="venueDraft.vatNumber" name="vatNumber" />
          </label>

          <label class="field">
            <span>Company Reg Number</span>
            <input type="text" [(ngModel)]="venueDraft.companyRegistrationNumber" name="companyRegistrationNumber" />
          </label>

          <label class="field">
            <span>Country Code</span>
            <input type="text" [(ngModel)]="venueDraft.countryCode" name="countryCode" />
          </label>

          <label class="field">
            <span>Currency</span>
            <input type="text" [(ngModel)]="venueDraft.currencyCode" name="currencyCode" />
          </label>

          <label class="field">
            <span>Time Zone</span>
            <input type="text" [(ngModel)]="venueDraft.timeZone" name="timeZone" />
          </label>

          <label class="field">
            <span>Locale</span>
            <input type="text" [(ngModel)]="venueDraft.locale" name="locale" />
          </label>

          <label class="field">
            <span>Default VAT %</span>
            <input type="number" min="0" step="0.01" [(ngModel)]="venueDraft.defaultVatRate" name="defaultVatRate" />
          </label>

          <label class="field">
            <span>Min Booking Notice (days)</span>
            <input
              type="number"
              min="0"
              step="1"
              [(ngModel)]="venueDraft.minimumBookingNoticeDays"
              name="minimumBookingNoticeDays" />
          </label>

          <label class="field">
            <span>Default Hold Period (days)</span>
            <input
              type="number"
              min="1"
              step="1"
              [(ngModel)]="venueDraft.defaultHoldPeriodDays"
              name="defaultHoldPeriodDays" />
          </label>

          <label class="field">
            <span>Hold Warning (days)</span>
            <input type="number" min="0" step="1" [(ngModel)]="venueDraft.holdWarningDays" name="holdWarningDays" />
          </label>

          <label class="field">
            <span>Max Holds per Date/Space</span>
            <input
              type="number"
              min="1"
              step="1"
              [(ngModel)]="venueDraft.maxHoldsPerDateAndSpace"
              name="maxHoldsPerDateAndSpace" />
          </label>

          <label class="field">
            <span>Hold Auto Release</span>
            <select [(ngModel)]="venueDraft.holdAutoReleaseMode" name="holdAutoReleaseMode">
              @for (mode of holdAutoReleaseModes; track mode) {
                <option [value]="mode">{{ mode }}</option>
              }
            </select>
          </label>

          <label class="field span-2">
            <span>Address Line 1</span>
            <input type="text" [(ngModel)]="venueDraft.addressLine1" name="addressLine1" />
          </label>

          <label class="field span-2">
            <span>Address Line 2</span>
            <input type="text" [(ngModel)]="venueDraft.addressLine2" name="addressLine2" />
          </label>

          <label class="field">
            <span>City</span>
            <input type="text" [(ngModel)]="venueDraft.city" name="city" />
          </label>

          <label class="field">
            <span>Region</span>
            <input type="text" [(ngModel)]="venueDraft.region" name="region" />
          </label>

          <label class="field">
            <span>Postcode</span>
            <input type="text" [(ngModel)]="venueDraft.postcode" name="postcode" />
          </label>
        </div>

        <div class="panel-actions">
          <button type="button" class="primary" (click)="saveVenue()" [disabled]="savingVenue || loadingVenueProfile">
            {{ savingVenue ? 'Saving...' : 'Save Venue' }}
          </button>
        </div>
      }
    </article>

    <article class="panel">
      <div class="panel-header">
        <div>
          <h2>User Management</h2>
          <p>Create users directly and manage active status.</p>
        </div>
      </div>

      @if (userMessage) {
        <p class="hint">{{ userMessage }}</p>
      }

      <div class="invite-grid">
        <label class="field">
          <span>First Name</span>
          <input type="text" [(ngModel)]="inviteForm.firstName" name="inviteFirstName" />
        </label>
        <label class="field">
          <span>Last Name</span>
          <input type="text" [(ngModel)]="inviteForm.lastName" name="inviteLastName" />
        </label>
        <label class="field span-2">
          <span>Email</span>
          <input type="email" [(ngModel)]="inviteForm.email" name="inviteEmail" />
        </label>
        <label class="field">
          <span>Password</span>
          <input type="password" [(ngModel)]="inviteForm.password" name="createPassword" autocomplete="new-password" />
        </label>
        <label class="field">
          <span>Confirm Password</span>
          <input
            type="password"
            [(ngModel)]="inviteForm.confirmPassword"
            name="createConfirmPassword"
            autocomplete="new-password" />
        </label>
        <label class="field">
          <span>Phone (optional)</span>
          <input type="text" [(ngModel)]="inviteForm.phoneNumberE164" name="invitePhone" placeholder="+447700900111" />
        </label>
        <label class="field">
          <span>Role</span>
          <select [(ngModel)]="inviteForm.role" name="inviteRole">
            @for (role of roleOptions; track role) {
              <option [value]="role">{{ role }}</option>
            }
          </select>
        </label>
        <label class="check-field span-2">
          <input type="checkbox" [(ngModel)]="inviteForm.requiresTotp" name="inviteRequiresTotp" />
          <span>Require TOTP 2FA on first sign-in</span>
        </label>
      </div>

      <div class="panel-actions">
        <button type="button" class="primary" (click)="createUser()" [disabled]="creatingUser || !selectedVenueId">
          {{ creatingUser ? 'Creating...' : 'Create User' }}
        </button>
      </div>

      @if (editingUser) {
        <div class="password-panel">
          <div class="password-panel-header">
            <h3>Edit User</h3>
            <p>{{ editingUser.firstName }} {{ editingUser.lastName }} ({{ editingUser.email }})</p>
          </div>

          <div class="password-grid">
            <label class="field">
              <span>First Name</span>
              <input
                type="text"
                [(ngModel)]="editUserForm.firstName"
                [ngModelOptions]="{ standalone: true }"
                name="editUserFirstName" />
            </label>

            <label class="field">
              <span>Last Name</span>
              <input
                type="text"
                [(ngModel)]="editUserForm.lastName"
                [ngModelOptions]="{ standalone: true }"
                name="editUserLastName" />
            </label>

            <label class="field span-2">
              <span>Email</span>
              <input
                type="email"
                [(ngModel)]="editUserForm.email"
                [ngModelOptions]="{ standalone: true }"
                name="editUserEmail"
                autocomplete="email" />
            </label>

            <label class="field">
              <span>New Password</span>
              <input
                type="password"
                [(ngModel)]="editUserForm.password"
                [ngModelOptions]="{ standalone: true }"
                name="newPassword"
                autocomplete="new-password" />
            </label>

            <label class="field">
              <span>Confirm Password</span>
              <input
                type="password"
                [(ngModel)]="editUserForm.confirmPassword"
                [ngModelOptions]="{ standalone: true }"
                name="confirmPassword"
                autocomplete="new-password" />
            </label>
          </div>

          <p class="hint">Leave password fields empty to keep the current password.</p>

          <div class="password-actions">
            <button type="button" class="secondary" (click)="cancelEditUser()" [disabled]="savingUserEdit">Cancel</button>
            <button type="button" class="primary" (click)="saveEditedUser()" [disabled]="savingUserEdit">
              {{ savingUserEdit ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>
        </div>
      }

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role (Selected Venue)</th>
              <th>2FA</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @if (loadingUsers) {
              <tr>
                <td colspan="6" class="empty-row">Loading users...</td>
              </tr>
            } @else {
              @for (user of users; track user.id) {
                <tr>
                  <td>{{ user.firstName }} {{ user.lastName }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ roleForSelectedVenue(user) }}</td>
                  <td>{{ user.requiresTotp ? 'Required' : 'Optional' }}</td>
                  <td>
                    <span class="status" [class.active]="user.isActive" [class.inactive]="!user.isActive">
                      {{ user.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td class="actions">
                    <button
                      type="button"
                      (click)="setUserActive(user, !user.isActive)"
                      [disabled]="updatingUserStatus || savingUserEdit || creatingUser">
                      {{ user.isActive ? 'Deactivate' : 'Activate' }}
                    </button>
                    <button
                      type="button"
                      class="secondary"
                      (click)="beginEditUser(user)"
                      [disabled]="savingUserEdit || creatingUser">
                      Edit User
                    </button>
                  </td>
                </tr>
              }

              @if (users.length === 0) {
                <tr>
                  <td colspan="6" class="empty-row">No users assigned to this venue.</td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </article>

    <article class="panel dedupe-panel">
      <div class="panel-header">
        <div>
          <h2>Duplicate Enquiry Candidates</h2>
          <p>Background deduplication identifies likely duplicate enquiry pairs for review and merge.</p>
        </div>
      </div>

      <div class="dedupe-actions">
        <label class="field">
          <span>Minimum confidence</span>
          <input
            type="number"
            min="0"
            max="100"
            step="1"
            [(ngModel)]="dedupeConfidenceMin"
            [ngModelOptions]="{ standalone: true }" />
        </label>
        <button type="button" class="secondary" (click)="refreshDeduplicationReport()" [disabled]="dedupeLoading || !selectedVenueId">
          {{ dedupeLoading ? 'Refreshing...' : 'Refresh' }}
        </button>
        <button type="button" class="primary" (click)="runDeduplicationScan()" [disabled]="dedupeRunning || !selectedVenueId">
          {{ dedupeRunning ? 'Running...' : 'Run Scan Now' }}
        </button>
      </div>

      @if (dedupeError) {
        <p class="page-error">{{ dedupeError }}</p>
      }

      @if (dedupeReport) {
        <p class="dedupe-summary">
          Generated {{ dedupeReport.generatedAtUtc | date: 'dd/MM/yyyy HH:mm' }} 路
          Showing {{ dedupeCandidates.length }} of {{ dedupeReport.candidates.length }} candidate pair(s)
        </p>
      }

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Primary</th>
              <th>Secondary</th>
              <th>Signals</th>
              <th>Confidence</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @if (dedupeLoading) {
              <tr>
                <td colspan="5" class="empty-row">Loading duplicate candidates...</td>
              </tr>
            } @else {
              @for (candidate of dedupeCandidates; track candidate.primaryEnquiryId + ':' + candidate.secondaryEnquiryId) {
                <tr>
                  <td>
                    <div class="cell-main">{{ candidate.primaryReference }}</div>
                    <div class="cell-sub">{{ candidate.primaryContactName }} 路 {{ candidate.primaryEventStartUtc | date: 'dd/MM/yyyy' }}</div>
                  </td>
                  <td>
                    <div class="cell-main">{{ candidate.secondaryReference }}</div>
                    <div class="cell-sub">{{ candidate.secondaryContactName }} 路 {{ candidate.secondaryEventStartUtc | date: 'dd/MM/yyyy' }}</div>
                  </td>
                  <td>
                    <div class="dedupe-signal-list">
                      @if (candidate.matchedOnEmail) { <span>Email</span> }
                      @if (candidate.matchedOnPhone) { <span>Phone</span> }
                      @if (candidate.matchedOnNameAndDate) { <span>Name + Date</span> }
                    </div>
                  </td>
                  <td>{{ candidate.confidenceScore }}%</td>
                  <td class="actions">
                    <button type="button" class="secondary" (click)="openDedupeEnquiry(candidate.primaryEnquiryId)">View</button>
                    <button type="button" (click)="mergeDedupeCandidate(candidate)">Merge</button>
                  </td>
                </tr>
              }

              @if (dedupeCandidates.length === 0) {
                <tr>
                  <td colspan="5" class="empty-row">No duplicate candidates found for the selected confidence threshold.</td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </article>
  </section>
  }

  @if (adminTab === 'audit') {
    <section class="audit-panel panel">
      <div class="panel-header">
        <div>
          <h2>System Audit Log</h2>
          <p>Immutable system-wide audit trail for compliance and operational visibility.</p>
        </div>
      </div>

      <div class="audit-retention">
        <label class="field">
          <span>Retention (days)</span>
          <input
            type="number"
            min="30"
            max="3650"
            [(ngModel)]="auditRetentionDays"
            [ngModelOptions]="{ standalone: true }" />
        </label>
        <button type="button" class="primary" (click)="saveAuditRetentionSettings()" [disabled]="auditSavingRetention || !selectedVenueId">
          {{ auditSavingRetention ? 'Saving...' : 'Save Retention' }}
        </button>
      </div>

      <div class="audit-filters">
        <label class="field">
          <span>Search</span>
          <input
            type="text"
            [(ngModel)]="auditFilter.search"
            [ngModelOptions]="{ standalone: true }"
            (keyup.enter)="onAuditFiltersChanged()"
            placeholder="Action, details, IP, user..." />
        </label>
        <label class="field">
          <span>Enquiry Ref</span>
          <input
            type="text"
            [(ngModel)]="auditFilter.enquiryRef"
            [ngModelOptions]="{ standalone: true }"
            (keyup.enter)="onAuditFiltersChanged()"
            placeholder="ENQ-2026-0001" />
        </label>
        <label class="field">
          <span>User</span>
          <select [(ngModel)]="auditFilter.userId" [ngModelOptions]="{ standalone: true }" (change)="onAuditFiltersChanged()">
            <option value="">All users</option>
            @for (user of auditUsers; track user.id) {
              <option [value]="user.id">{{ user.firstName }} {{ user.lastName }}</option>
            }
          </select>
        </label>
        <label class="field">
          <span>Action</span>
          <select [(ngModel)]="auditFilter.actionType" [ngModelOptions]="{ standalone: true }" (change)="onAuditFiltersChanged()">
            <option value="">All actions</option>
            @for (value of auditActionTypes; track value) {
              <option [value]="value">{{ value }}</option>
            }
          </select>
        </label>
        <label class="field">
          <span>Entity Type</span>
          <select [(ngModel)]="auditFilter.entityType" [ngModelOptions]="{ standalone: true }" (change)="onAuditFiltersChanged()">
            <option value="">All entities</option>
            @for (value of auditEntityTypes; track value) {
              <option [value]="value">{{ value }}</option>
            }
          </select>
        </label>
        <label class="field">
          <span>From</span>
          <input type="date" [(ngModel)]="auditFilter.fromDate" [ngModelOptions]="{ standalone: true }" (change)="onAuditFiltersChanged()" />
        </label>
        <label class="field">
          <span>To</span>
          <input type="date" [(ngModel)]="auditFilter.toDate" [ngModelOptions]="{ standalone: true }" (change)="onAuditFiltersChanged()" />
        </label>
        <div class="audit-filter-actions">
          <button type="button" class="secondary" (click)="onAuditFiltersChanged()" [disabled]="auditLoading">Apply</button>
          <button type="button" class="secondary" (click)="exportAuditCsv()" [disabled]="auditExporting || auditLoading">
            {{ auditExporting ? 'Exporting...' : 'Export CSV' }}
          </button>
        </div>
      </div>

      @if (auditError) {
        <p class="page-error">{{ auditError }}</p>
      }

      <div class="audit-summary">Showing {{ auditRows.length }} of {{ auditTotalCount }} events</div>

      <div class="table-wrap audit-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Action</th>
              <th>Entity Type</th>
              <th>Entity ID / Ref</th>
              <th>Details</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody>
            @if (auditLoading) {
              <tr>
                <td colspan="7" class="empty-row">Loading audit log...</td>
              </tr>
            } @else {
              @for (entry of auditRows; track entry.id) {
                <tr>
                  <td>{{ entry.createdAtUtc | date: 'dd/MM/yyyy HH:mm:ss' }}</td>
                  <td>{{ entry.userName || 'System' }}</td>
                  <td>
                    <span class="audit-action" [attr.data-token]="actionBadge(entry.actionCategory)">
                      {{ entry.actionType }}
                    </span>
                  </td>
                  <td>{{ entry.entityType }}</td>
                  <td>{{ entry.entityId }}@if (entry.enquiryReference) { 路 {{ entry.enquiryReference }} }</td>
                  <td>{{ entry.details || '-' }}</td>
                  <td>{{ entry.ipAddress || '-' }}</td>
                </tr>
              }
              @if (!auditLoading && auditRows.length === 0) {
                <tr>
                  <td colspan="7" class="empty-row">No audit entries match the current filters.</td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <footer class="audit-pagination">
        <button type="button" class="secondary" (click)="goToPreviousAuditPage()" [disabled]="auditLoading || auditPage <= 1">Previous</button>
        <span>Page {{ auditPage }}</span>
        <button type="button" class="secondary" (click)="goToNextAuditPage()" [disabled]="auditLoading || !auditHasMore">Next</button>
      </footer>
    </section>
  }
</section>
