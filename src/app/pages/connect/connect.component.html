<section class="connect-page">
  <header class="page-header">
    <div>
      <h1>Connect</h1>
      <p>Unified communications timeline, unmatched inbox, and team chat.</p>
    </div>
    <div class="page-header-actions">
      <div class="status-pills">
        <span>Unmatched: {{ unmatchedEmailCount }}</span>
        <span>@ Mentions: {{ unreadMentionCount }}</span>
      </div>
      <button type="button" class="add-task-btn" (click)="openAddTask()">+ Add Task</button>
    </div>
  </header>

  <section class="layout-grid">
    <article class="panel timeline-panel">
      <header>
        <h2>Timeline</h2>
        <div class="tabs">
          <button type="button" [class.active]="timelineType === 'all'" (click)="setTimelineType('all')">All</button>
          <button type="button" [class.active]="timelineType === 'emails'" (click)="setTimelineType('emails')">Emails</button>
          <button type="button" [class.active]="timelineType === 'notes'" (click)="setTimelineType('notes')">Notes</button>
          <button type="button" [class.active]="timelineType === 'system'" (click)="setTimelineType('system')">System</button>
        </div>
      </header>

      <div class="search-row">
        <input type="text" [(ngModel)]="timelineSearch" (ngModelChange)="loadTimeline()" placeholder="Search within communications" />
      </div>

      <ul class="timeline-list">
        @if (isLoadingTimeline) {
          <li class="empty">Loading timeline...</li>
        }

        @for (item of timeline; track item.id) {
          <li [class.selected]="selectedEnquiryId === item.enquiryId" [class.internal-note]="item.type === 'note'" (click)="selectTimelineItem(item)">
            <div class="line-top">
              <strong>{{ item.enquiryReference }}</strong>
              <span>{{ item.occurredAtUtc | date: 'dd/MM HH:mm' }}</span>
            </div>
            <p>{{ item.subject || item.preview }}</p>
            @if (item.fromAddress || item.toAddresses) {
              <small class="recipient-meta">
                @if (item.fromAddress) {
                  <span><strong>From:</strong> {{ item.fromAddress }}</span>
                }
                @if (item.toAddresses) {
                  <span><strong>To:</strong> {{ item.toAddresses }}</span>
                }
              </small>
            }
            <div class="line-meta">
              <span class="type-badge" [class]="timelineTypeBadgeClass(item.type)">
                <i>{{ timelineTypeBadgeIcon(item.type) }}</i>
                {{ timelineTypeBadgeLabel(item.type) }}
              </span>
              <small>{{ item.contactName }} · {{ item.direction }}</small>
              @if (item.deliveredAtUtc) {
                <small>Delivered {{ item.deliveredAtUtc | date: 'dd/MM HH:mm' }}</small>
              }
              @if (item.openedAtUtc) {
                <small>Opened {{ item.openedAtUtc | date: 'dd/MM HH:mm' }}</small>
              }
              @if (item.attachmentCount > 0) {
                <small>{{ item.attachmentCount }} attachment{{ item.attachmentCount === 1 ? '' : 's' }}</small>
              }
            </div>
          </li>
        }

        @if (!isLoadingTimeline && timeline.length === 0) {
          <li class="empty">No communications found.</li>
        }
      </ul>
    </article>

    <article class="panel compose-panel">
      <header>
        <h2>Compose</h2>
        <span>{{ selectedEnquiryId || 'Select an enquiry' }}</span>
      </header>

      <section>
        <h3>Internal Note</h3>
        <textarea [(ngModel)]="noteDraft" rows="4" placeholder="Add internal note and use @mentions."></textarea>
        <button type="button" class="primary-action" (click)="addNote()" [disabled]="!canCompose || !noteDraft.trim()">Add Note</button>
      </section>

      <section class="compose-message-section">
        <div class="compose-channel-tabs">
          <button type="button" [class.active]="composeChannel === 'email'" (click)="setComposeChannel('email')">Email</button>
          <button type="button" [class.active]="composeChannel === 'portal'" (click)="setComposeChannel('portal')">Portal Message</button>
        </div>

        @if (composeChannel === 'email') {
          <h3>Email</h3>
          <div class="compose-toolbar">
            <button type="button" class="toolbar-button" (click)="toggleTemplatePicker()" [disabled]="!canCompose || templatesLoading">
              Templates
            </button>
            <button type="button" class="toolbar-button" (click)="toggleEmailCopyFields()" [disabled]="!canCompose">
              {{ showEmailCopyFields ? 'Hide CC/BCC' : 'Show CC/BCC' }}
            </button>
            <label class="toolbar-button attach-button" [class.disabled]="!canAttachFiles">
              <span>Attach</span>
              <input type="file" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.csv" (change)="onAttachmentBrowse($event)" [disabled]="!canAttachFiles" />
            </label>
          </div>

          @if (showTemplatePicker) {
            <div class="template-picker">
              @if (templatesLoading) {
                <p>Loading templates...</p>
              } @else if (availableTemplates.length > 0) {
                @for (template of availableTemplates; track template.key) {
                  <button type="button" (click)="applyTemplate(template)">
                    <strong>{{ template.name }}</strong>
                    <small>{{ template.category || 'Custom' }} · {{ template.subjectTemplate }}</small>
                  </button>
                }
              } @else {
                <p>{{ templateError || 'No active templates available.' }}</p>
              }
            </div>
          }

          <input type="email" [(ngModel)]="emailTo" placeholder="To" />
          @if (showEmailCopyFields) {
            <input type="text" [(ngModel)]="emailCc" placeholder="CC (optional)" />
            <input type="text" [(ngModel)]="emailBcc" placeholder="BCC (optional)" />
          }
          <input type="text" [(ngModel)]="emailSubject" placeholder="Subject" />
          <quill-editor
            [(ngModel)]="emailBody"
            [modules]="composeEditorModules"
            [placeholder]="'Write email message...'"
            [styles]="{ height: '170px' }"></quill-editor>

          <div class="merge-preview">
            <strong>Merge Preview</strong>
            <div>
              @for (preview of mergeFieldPreviewList; track preview) {
                <small>{{ preview }}</small>
              }
            </div>
          </div>

          <div
            class="attachment-dropzone"
            [class.drag-active]="isAttachmentDragActive"
            [class.disabled]="!canAttachFiles"
            (dragover)="onAttachmentDragOver($event)"
            (dragleave)="onAttachmentDragLeave($event)"
            (drop)="onAttachmentDrop($event)">
            <p>Drag and drop files here or use Attach.</p>
            <small>Max 10MB per file, 25MB total. PDF, DOC/X, XLS/X, JPG, PNG, CSV.</small>
          </div>

          @if (attachments.length > 0) {
            <div class="attachment-chip-list">
              @for (attachment of attachments; track attachment.id) {
                <span class="attachment-chip">
                  {{ attachment.fileName }} ({{ formatAttachmentSize(attachment.sizeBytes) }})
                  <button type="button" (click)="removeAttachment(attachment.id)" aria-label="Remove attachment">×</button>
                </span>
              }
            </div>
            <small class="attachment-total">Total: {{ formatAttachmentSize(attachmentTotalBytes) }}</small>
          }
        } @else {
          <h3>Portal Message</h3>
          <input type="text" [(ngModel)]="portalSubject" placeholder="Subject (optional)" />
          <textarea [(ngModel)]="portalBody" rows="6" placeholder="Message visible in client portal inbox"></textarea>
        }

        @if (attachmentError) {
          <p class="compose-error">{{ attachmentError }}</p>
        }
        @if (composeError) {
          <p class="compose-error">{{ composeError }}</p>
        }
        @if (composeSuccess) {
          <p class="compose-success">{{ composeSuccess }}</p>
        }

        <button
          type="button"
          class="primary-action"
          (click)="sendCompose()"
          [disabled]="composeChannel === 'email' ? !canSendEmail : !canSendPortalMessage">
          {{ isSendingCompose ? 'Sending...' : composeChannel === 'email' ? 'Send Email' : 'Send Portal Message' }}
        </button>
      </section>

      <section>
        <h3>Unmatched Inbox</h3>
        <ul class="unmatched-list">
          @for (email of unmatchedInbox; track email.id) {
            <li>
              <div>
                <strong>{{ email.subject }}</strong>
                <p>{{ email.fromAddress }} · {{ email.receivedAtUtc | date: 'dd/MM HH:mm' }}</p>
                <small>{{ email.preview }}</small>
              </div>
              <button type="button" (click)="linkUnmatched(email)" [disabled]="!canCompose">Link</button>
            </li>
          }
          @if (unmatchedInbox.length === 0) {
            <li class="empty">No unmatched emails.</li>
          }
        </ul>
      </section>
    </article>

    <article class="panel chat-panel">
      <header>
        <h2>Team Chat</h2>
      </header>

      <div class="chat-layout">
        <aside>
          <ul>
            @for (channel of channels; track channel.id) {
              <li [class.active]="selectedChannelId === channel.id" (click)="openChannel(channel)">
                <strong>#{{ channel.slug }}</strong>
                @if (channel.unreadCount > 0) {
                  <span>{{ channel.unreadCount }}</span>
                }
                <small>{{ channel.lastMessagePreview || 'No messages yet' }}</small>
              </li>
            }
            @if (channels.length === 0) {
              <li class="empty">No channels.</li>
            }
          </ul>
        </aside>

        <section>
          <div class="messages">
            @if (isLoadingChat) {
              <p class="empty">Loading chat...</p>
            }
            @for (message of chatMessages; track message.id) {
              <article>
                <div>
                  <strong>{{ message.senderName }}</strong>
                  <span>{{ message.createdAtUtc | date: 'dd/MM HH:mm' }}</span>
                </div>
                <p>{{ message.body }}</p>
              </article>
            }
            @if (!isLoadingChat && chatMessages.length === 0) {
              <p class="empty">No messages in this channel.</p>
            }
          </div>

          <div class="chat-compose">
            <textarea [(ngModel)]="chatDraft" rows="3" placeholder="Message channel"></textarea>
            <button type="button" (click)="sendChatMessage()" [disabled]="!selectedChannelId || !chatDraft.trim()">Send</button>
          </div>
        </section>
      </div>
    </article>
  </section>
</section>

<app-task-quick-create-modal
  [isOpen]="showAddTaskModal"
  [defaultEnquiryId]="selectedEnquiryId || null"
  (close)="closeAddTaskModal()"
  (created)="onTaskQuickCreated($event)">
</app-task-quick-create-modal>
