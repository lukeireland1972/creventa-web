<section class="reports-page">
  <header class="page-header">
    <div>
      <h1>Reports</h1>
      <p>Commercial performance, conversion, and forecast insights for your venue.</p>
    </div>
  </header>

  <section class="filters-card">
    <div class="preset-row" role="group" aria-label="Date presets">
      <button type="button" [class.active]="selectedPreset === 'this-month'" (click)="applyPreset('this-month')">This Month</button>
      <button type="button" [class.active]="selectedPreset === 'last-30d'" (click)="applyPreset('last-30d')">Last 30d</button>
      <button type="button" [class.active]="selectedPreset === 'last-90d'" (click)="applyPreset('last-90d')">Last 90d</button>
      <button type="button" [class.active]="selectedPreset === 'this-year'" (click)="applyPreset('this-year')">This Year</button>
    </div>

    <div class="filter-row">
      <label>
        From
        <input type="date" [(ngModel)]="fromDate" (ngModelChange)="onManualDateChange()" />
      </label>
      <label>
        To
        <input type="date" [(ngModel)]="toDate" (ngModelChange)="onManualDateChange()" />
      </label>
      <label>
        Event Type
        <select [(ngModel)]="eventType">
          @for (type of eventTypes; track type) {
            <option [value]="type">{{ type === 'all' ? 'All Event Types' : type }}</option>
          }
        </select>
      </label>
      <button type="button" class="apply-btn" (click)="loadReports()">Apply Filters</button>
    </div>

    <div class="compare-row">
      <label class="compare-toggle">
        <input type="checkbox" [(ngModel)]="compareEnabled" (ngModelChange)="onCompareToggle()" />
        Enable comparison range
      </label>

      @if (compareEnabled) {
        <label>
          Compare From
          <input type="date" [(ngModel)]="compareFromDate" />
        </label>
        <label>
          Compare To
          <input type="date" [(ngModel)]="compareToDate" />
        </label>
      }
    </div>
  </section>

  @if (errorMessage) {
    <article class="state-card error">
      <h2>Unable to load reports</h2>
      <p>{{ errorMessage }}</p>
      <button type="button" (click)="loadReports()">Retry</button>
    </article>
  } @else if (isLoading) {
    <article class="state-card">
      <h2>Loading reports</h2>
      <p>Preparing charts and tables from your venue data.</p>
    </article>
  } @else {
    <section class="reports-grid">
      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Sales Performance</h2>
            <p>Confirmed bookings by month with revenue and average booking value.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('sales-performance', 'csv')" (click)="exportSection('sales-performance', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('sales-performance', 'pdf')" (click)="exportSection('sales-performance', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('sales-performance')">Schedule</button>
            @if (getActiveScheduleCount('sales-performance') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('sales-performance') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Monthly Revenue (Bar Chart)</div>
          <div class="vertical-bar-chart" role="img" aria-label="Sales performance revenue by month">
            @for (point of salesBarPoints; track point.month) {
              <div class="bar-column">
                <small class="bar-value">{{ formatCurrency(point.totalRevenue, point.currencyCode) }}</small>
                <div class="bar-track">
                  <span class="bar-fill primary" [style.height.%]="point.heightPercent"></span>
                </div>
                <span class="bar-label">{{ point.monthLabel }}</span>
              </div>
            }
            @if (salesBarPoints.length === 0) {
              <p class="empty">No confirmed booking data for this period.</p>
            }
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Number of Bookings</th>
                <th>Total Revenue</th>
                <th>Average Booking Value</th>
              </tr>
            </thead>
            <tbody>
              @for (row of salesRows; track row.month) {
                <tr>
                  <td>{{ formatMonth(row.month) }}</td>
                  <td>{{ row.numberOfBookings }}</td>
                  <td>{{ formatCurrency(row.totalRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.averageBookingValue, row.currencyCode) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card">
        <header class="card-header">
          <div>
            <h2>Pipeline Conversion</h2>
            <p>Funnel from New to Confirmed and Lost.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('pipeline-conversion', 'csv')" (click)="exportSection('pipeline-conversion', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('pipeline-conversion', 'pdf')" (click)="exportSection('pipeline-conversion', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('pipeline-conversion')">Schedule</button>
            @if (getActiveScheduleCount('pipeline-conversion') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('pipeline-conversion') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Stage Funnel</div>
          <div class="funnel-chart" role="img" aria-label="Pipeline conversion funnel">
            @for (row of pipelineFunnelRows; track row.stage) {
              <div class="funnel-band" [style.width.%]="row.widthPercent">
                <div class="funnel-band-main">
                  <strong>{{ row.stage }}</strong>
                  <span>{{ row.count }}</span>
                </div>
                <small>{{ formatPercent(row.conversionFromPreviousPercent) }} from previous · {{ formatPercent(row.conversionFromNewPercent) }} from new</small>
              </div>
            }
            @if (pipelineFunnelRows.length === 0) {
              <p class="empty">No pipeline data for this period.</p>
            }
          </div>
          @if (pipelineConversionReport?.note) {
            <p class="helper-note">{{ pipelineConversionReport?.note }}</p>
          }
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Stage</th>
                <th>Count</th>
                <th>From Previous</th>
                <th>From New</th>
              </tr>
            </thead>
            <tbody>
              @for (row of pipelineRows; track row.stage) {
                <tr>
                  <td>{{ row.stage }}</td>
                  <td>{{ row.count }}</td>
                  <td>{{ formatPercent(row.conversionFromPreviousPercent) }}</td>
                  <td>{{ formatPercent(row.conversionFromNewPercent) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card">
        <header class="card-header">
          <div>
            <h2>Revenue by Space</h2>
            <p>Confirmed event revenue and utilisation by space.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('revenue-space', 'csv')" (click)="exportSection('revenue-space', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('revenue-space', 'pdf')" (click)="exportSection('revenue-space', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('revenue-space')">Schedule</button>
            @if (getActiveScheduleCount('revenue-space') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('revenue-space') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Revenue by Space (Bar Chart)</div>
          <div class="vertical-bar-chart" role="img" aria-label="Revenue by space">
            @for (point of revenueBySpaceBarPoints; track point.month) {
              <div class="bar-column">
                <small class="bar-value">{{ formatCurrency(point.totalRevenue, point.currencyCode) }}</small>
                <div class="bar-track">
                  <span class="bar-fill primary" [style.height.%]="point.heightPercent"></span>
                </div>
                <span class="bar-label">{{ point.monthLabel }}</span>
              </div>
            }
            @if (revenueBySpaceBarPoints.length === 0) {
              <p class="empty">No confirmed revenue by space for this period.</p>
            }
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Space Name</th>
                <th>Booking Count</th>
                <th>Total Revenue</th>
                <th>Avg Booking Value</th>
                <th>Utilisation Rate</th>
              </tr>
            </thead>
            <tbody>
              @for (row of revenueBySpaceRows; track row.spaceId) {
                <tr>
                  <td>{{ row.spaceName }}</td>
                  <td>{{ row.bookingCount }}</td>
                  <td>{{ formatCurrency(row.totalRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.averageBookingValue, row.currencyCode) }}</td>
                  <td>{{ formatPercent(row.utilisationRatePercent) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Revenue by Event Type</h2>
            <p>Revenue share, counts, value and covers with side-by-side comparison metrics.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('revenue-event-type', 'csv')" (click)="exportSection('revenue-event-type', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('revenue-event-type', 'pdf')" (click)="exportSection('revenue-event-type', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('revenue-event-type')">Schedule</button>
            @if (getActiveScheduleCount('revenue-event-type') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('revenue-event-type') }}</span>
            }
          </div>
        </header>

        <div class="source-layout">
          <div class="donut" [style.background]="revenueByEventTypeDonutBackground">
            <div class="donut-hole">
              <strong>{{ formatCurrency(revenueByEventTypeTotal, revenueByEventTypeCurrencyCode) }}</strong>
              <small>Total</small>
            </div>
          </div>

          <ul class="legend">
            @for (row of revenueByEventTypeRows; track row.eventType; let i = $index) {
              <li>
                <span class="dot" [style.background]="getEventTypeColor(i)"></span>
                <span class="name">{{ row.eventType }}</span>
                <strong>{{ formatCurrency(row.totalRevenue, row.currencyCode) }}</strong>
                <small>{{ formatPercent(row.revenueSharePercent) }}</small>
              </li>
            }
            @if (revenueByEventTypeRows.length === 0) {
              <li class="empty">No event type revenue data available.</li>
            }
          </ul>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Event Type</th>
                <th>Count</th>
                <th>Total Revenue</th>
                <th>Avg Value</th>
                <th>Avg Covers</th>
                <th>Compare Revenue</th>
                <th>Δ Revenue</th>
                <th>Δ %</th>
              </tr>
            </thead>
            <tbody>
              @for (row of revenueByEventTypeRows; track row.eventType) {
                <tr>
                  <td>{{ row.eventType }}</td>
                  <td>{{ row.count }}</td>
                  <td>{{ formatCurrency(row.totalRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.averageValue, row.currencyCode) }}</td>
                  <td>{{ row.averageCovers | number: '1.0-2' }}</td>
                  <td>{{ formatCurrency(row.compareTotalRevenue, row.currencyCode) }}</td>
                  <td [class]="varianceClass(row.revenueDelta)">{{ formatCurrency(row.revenueDelta, row.currencyCode) }}</td>
                  <td [class]="varianceClass(row.revenueDelta)">{{ formatNullablePercent(row.revenueDeltaPercent) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        @if (revenueByEventTypeReport?.note) {
          <p class="helper-note">{{ revenueByEventTypeReport?.note }}</p>
        }
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Sales Team Performance</h2>
            <p>Operator-level pipeline and productivity performance.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('sales-team-performance', 'csv')" (click)="exportSection('sales-team-performance', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('sales-team-performance', 'pdf')" (click)="exportSection('sales-team-performance', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('sales-team-performance')">Schedule</button>
            @if (getActiveScheduleCount('sales-team-performance') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('sales-team-performance') }}</span>
            }
          </div>
        </header>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Event Manager</th>
                <th>Enquiries</th>
                <th>Proposals Sent</th>
                <th>Conversion Rate</th>
                <th>Revenue (Confirmed)</th>
                <th>Avg Response Time</th>
                <th>Tasks Completed</th>
                <th>Appointments Held</th>
                <th>Trend</th>
              </tr>
            </thead>
            <tbody>
              @for (row of salesTeamRows; track row.rank) {
                <tr>
                  <td>{{ row.rank }}</td>
                  <td>{{ row.eventManagerName }}</td>
                  <td>{{ row.enquiriesAssigned }}</td>
                  <td>{{ row.proposalsSent }}</td>
                  <td>{{ formatPercent(row.conversionRatePercent) }}</td>
                  <td>{{ formatCurrency(row.confirmedRevenue, row.currencyCode) }}</td>
                  <td>{{ row.averageResponseHours | number: '1.0-2' }}h</td>
                  <td>{{ row.tasksCompleted }}</td>
                  <td>{{ row.appointmentsHeld }}</td>
                  <td>
                    <div class="sparkline" [attr.aria-label]="sparklineLabel(row)">
                      @for (point of row.trend; track $index) {
                        <span class="sparkline-bar" [style.height.%]="sparklineHeight(point)"></span>
                      }
                      @if (row.trend.length === 0) {
                        <span class="sparkline-empty">No trend</span>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Forecast (Weighted Pipeline)</h2>
            <p>Confirmed + weighted pipeline by month compared with budget target.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('forecast', 'csv')" (click)="exportSection('forecast', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('forecast', 'pdf')" (click)="exportSection('forecast', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('forecast')">Schedule</button>
            @if (getActiveScheduleCount('forecast') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('forecast') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Stacked Area Forecast</div>
          @if (weightedForecastRows.length > 0) {
            <div class="trend-chart-canvas">
              <canvas #weightedForecastCanvas></canvas>
            </div>
          } @else {
            <p class="empty">No weighted forecast data for this period.</p>
          }
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Confirmed Value</th>
                <th>Weighted Pipeline Value</th>
                <th>Total Forecast</th>
                <th>Budget Target</th>
                <th>Variance</th>
                <th>Pace</th>
              </tr>
            </thead>
            <tbody>
              @for (row of weightedForecastRows; track row.month) {
                <tr>
                  <td>{{ formatMonth(row.month) }}</td>
                  <td>{{ formatCurrency(row.confirmedValue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.weightedPipelineValue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.totalForecast, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.budgetTarget, row.currencyCode) }}</td>
                  <td [class]="varianceClass(row.variance)">{{ formatCurrency(row.variance, row.currencyCode) }}</td>
                  <td [class]="paceStatusClass(row.paceStatus)">{{ row.paceStatus }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Budget / Pace by Event Type</h2>
            <p>Monthly event-type pace with LY and budget comparisons.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('budget-pace-event-type', 'csv')" (click)="exportSection('budget-pace-event-type', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('budget-pace-event-type', 'pdf')" (click)="exportSection('budget-pace-event-type', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('budget-pace-event-type')">Schedule</button>
            @if (getActiveScheduleCount('budget-pace-event-type') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('budget-pace-event-type') }}</span>
            }
          </div>
        </header>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Event Type</th>
                <th>Month</th>
                <th>Bookings (TY)</th>
                <th>Bookings (LY)</th>
                <th>Revenue (TY)</th>
                <th>Revenue (LY)</th>
                <th>Budget</th>
                <th>ASP (TY)</th>
                <th>ASP (LY)</th>
                <th>Avg Covers (TY)</th>
                <th>Avg Covers (LY)</th>
              </tr>
            </thead>
            <tbody>
              @for (row of budgetPaceByEventTypeRows; track row.eventType + '-' + row.month + '-' + row.rowType) {
                <tr [class.summary-row]="row.rowType === 'summary'">
                  <td>
                    @if (row.rowType === 'month') {
                      <button type="button" class="table-link" (click)="drillIntoBudgetPaceRow(row)">{{ row.eventType }}</button>
                    } @else {
                      {{ row.eventType }}
                    }
                  </td>
                  <td>{{ row.rowType === 'summary' ? 'Total' : formatMonth(row.month) }}</td>
                  <td>{{ row.bookingCountThisYear }}</td>
                  <td>{{ row.bookingCountLy }}</td>
                  <td>{{ formatCurrency(row.revenueThisYear, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.revenueLy, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.budgetRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.aspThisYear, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.aspLy, row.currencyCode) }}</td>
                  <td>{{ row.averageCoversThisYear | number: '1.0-2' }}</td>
                  <td>{{ row.averageCoversLy | number: '1.0-2' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        @if (budgetPaceByEventTypeReport?.note) {
          <p class="helper-note">{{ budgetPaceByEventTypeReport?.note }}</p>
        }
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Revenue Forecast vs Budget</h2>
            <p>Confirmed revenue compared to monthly budget targets.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('revenue-forecast', 'csv')" (click)="exportSection('revenue-forecast', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('revenue-forecast', 'pdf')" (click)="exportSection('revenue-forecast', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('revenue-forecast')">Schedule</button>
            @if (getActiveScheduleCount('revenue-forecast') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('revenue-forecast') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Predicted vs Actual Trend</div>
          @if (revenueForecastRows.length > 0) {
            <div class="trend-chart-canvas">
              <canvas #forecastTrendCanvas></canvas>
            </div>
          } @else {
            <p class="empty">No forecast data for this period.</p>
          }
        </div>

        <div class="chart-panel">
          <div class="chart-heading">Confirmed vs Predicted vs Budget (Grouped Bars)</div>
          <div class="grouped-bar-chart" role="img" aria-label="Revenue forecast compared to budget">
            @for (point of revenueGroupedBarPoints; track point.month) {
              <div class="group-column">
                <div class="group-bars three-series">
                  <span class="bar confirmed" [style.height.%]="point.confirmedHeightPercent" title="Confirmed"></span>
                  <span class="bar predicted" [style.height.%]="point.predictedHeightPercent" title="Predicted"></span>
                  <span class="bar budget" [style.height.%]="point.budgetHeightPercent" title="Budget"></span>
                </div>
                <span class="group-label">{{ point.monthLabel }}</span>
              </div>
            }
            @if (revenueGroupedBarPoints.length === 0) {
              <p class="empty">No forecast data for this period.</p>
            }
          </div>
          <div class="chart-key">
            <span><i class="chip confirmed"></i>Confirmed</span>
            <span><i class="chip predicted"></i>Predicted</span>
            <span><i class="chip budget"></i>Budget</span>
          </div>
          @if (revenueForecastReport?.note) {
            <p class="helper-note">{{ revenueForecastReport?.note }}</p>
          }
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Confirmed Revenue</th>
                <th>Predicted Revenue</th>
                <th>Budget Target</th>
                <th>Variance</th>
                <th>Variance %</th>
                <th>Predicted vs Actual</th>
              </tr>
            </thead>
            <tbody>
              @for (row of revenueForecastRows; track row.month) {
                <tr>
                  <td>{{ formatMonth(row.month) }}</td>
                  <td>{{ formatCurrency(row.confirmedRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.predictedRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.budgetTarget, row.currencyCode) }}</td>
                  <td [class]="varianceClass(row.variance)">{{ formatCurrency(row.variance, row.currencyCode) }}</td>
                  <td [class]="varianceClass(row.variance)">{{ formatPercent(row.variancePercent) }}</td>
                  <td [class]="varianceClass(row.predictionVariance)">{{ formatCurrency(row.predictionVariance, row.currencyCode) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Pace Report</h2>
            <p>On-books pace versus budget and same-month last-year snapshot.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('pace', 'csv')" (click)="exportSection('pace', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('pace', 'pdf')" (click)="exportSection('pace', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('pace')">Schedule</button>
            @if (getActiveScheduleCount('pace') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('pace') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Total On Books vs Budget vs LY</div>
          <div class="grouped-bar-chart" role="img" aria-label="Pace report on-books compared to budget and last year">
            @for (point of paceBarPoints; track point.month) {
              <div class="group-column">
                <div class="group-bars three-series">
                  <span class="bar on-books" [style.height.%]="point.totalOnBooksHeightPercent" title="Total On Books"></span>
                  <span class="bar budget" [style.height.%]="point.budgetHeightPercent" title="Budget"></span>
                  <span class="bar ly" [style.height.%]="point.lyHeightPercent" title="Same Month LY"></span>
                </div>
                <span class="group-label">{{ point.monthLabel }}</span>
              </div>
            }
            @if (paceBarPoints.length === 0) {
              <p class="empty">No pace data available.</p>
            }
          </div>
          <div class="chart-key">
            <span><i class="chip on-books"></i>Total On Books</span>
            <span><i class="chip budget"></i>Budget</span>
            <span><i class="chip ly"></i>Same Month LY</span>
          </div>
          @if (paceReport?.note) {
            <p class="helper-note">{{ paceReport?.note }}</p>
          }
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Budget Target</th>
                <th>Confirmed Revenue</th>
                <th>Weighted Pipeline</th>
                <th>Total On Books</th>
                <th>LY Snapshot</th>
                <th>Variance vs Budget</th>
                <th>Pace</th>
              </tr>
            </thead>
            <tbody>
              @for (row of paceRows; track row.month) {
                <tr>
                  <td>{{ formatMonth(row.month) }}</td>
                  <td>{{ formatCurrency(row.budgetTarget, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.confirmedRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.weightedPipelineRevenue, row.currencyCode) }}</td>
                  <td>{{ formatCurrency(row.totalOnBooks, row.currencyCode) }}</td>
                  <td>{{ row.sameMonthLyAtThisPoint > 0 ? formatCurrency(row.sameMonthLyAtThisPoint, row.currencyCode) : 'N/A' }}</td>
                  <td [class]="varianceClass(row.varianceVsBudget)">{{ formatCurrency(row.varianceVsBudget, row.currencyCode) }}</td>
                  <td [class]="paceStatusClass(row.paceStatus)">{{ row.paceStatus }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card report-wide">
        <header class="card-header">
          <div>
            <h2>Sustainability</h2>
            <p>Carbon footprint, waste diversion, and ESG score trends.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('sustainability', 'csv')" (click)="exportSection('sustainability', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('sustainability', 'pdf')" (click)="exportSection('sustainability', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('sustainability')">Schedule</button>
            @if (getActiveScheduleCount('sustainability') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('sustainability') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Carbon Trend (kgCO2e)</div>
          <div class="vertical-bar-chart" role="img" aria-label="Sustainability carbon trend by month">
            @for (point of sustainabilityBarPoints; track point.month) {
              <div class="bar-column">
                <small class="bar-value">{{ point.totalCarbonKgCo2e | number: '1.0-1' }} kg</small>
                <div class="bar-track">
                  <span class="bar-fill sustainability" [style.height.%]="point.carbonHeightPercent"></span>
                </div>
                <span class="bar-label">{{ point.monthLabel }}</span>
                <small class="bar-meta">Score {{ point.score | number: '1.0-1' }}</small>
              </div>
            }
            @if (sustainabilityBarPoints.length === 0) {
              <p class="empty">No sustainability data for this period.</p>
            }
          </div>
          @if (sustainabilityReport?.note) {
            <p class="helper-note">{{ sustainabilityReport?.note }}</p>
          }
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Events</th>
                <th>Total Carbon</th>
                <th>Diversion %</th>
                <th>Waste Diverted</th>
                <th>Avg ESG Score</th>
                <th>YoY Carbon Δ</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              @for (row of sustainabilityRows; track row.month) {
                <tr>
                  <td>{{ formatMonth(row.month) }}</td>
                  <td>{{ row.eventCount }}</td>
                  <td>{{ row.totalCarbonKgCo2e | number: '1.0-2' }} kg</td>
                  <td>{{ formatPercent(row.wasteDiversionPercent) }}</td>
                  <td>{{ row.wasteDivertedKg | number: '1.0-2' }} kg</td>
                  <td>{{ row.averageSustainabilityScore | number: '1.0-1' }}</td>
                  <td [class]="varianceClass(-row.yoyCarbonDeltaPercent)">{{ formatPercent(row.yoyCarbonDeltaPercent) }}</td>
                  <td [class]="paceStatusClass(row.status)">{{ row.status }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </article>

      <article class="report-card">
        <header class="card-header">
          <div>
            <h2>Source Analysis</h2>
            <p>Enquiry distribution by lead source.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('source-analysis', 'csv')" (click)="exportSection('source-analysis', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('source-analysis', 'pdf')" (click)="exportSection('source-analysis', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('source-analysis')">Schedule</button>
            @if (getActiveScheduleCount('source-analysis') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('source-analysis') }}</span>
            }
          </div>
        </header>

        <div class="source-layout">
          <div class="donut" [style.background]="sourceDonutBackground">
            <div class="donut-hole">
              <strong>{{ sourceTotal }}</strong>
              <small>Total</small>
            </div>
          </div>

          <ul class="legend">
            @for (row of sourceRows; track row.source) {
              <li>
                <span class="dot" [style.background]="row.color"></span>
                <span class="name">{{ row.source }}</span>
                <strong>{{ row.count }}</strong>
                <small>{{ formatPercent(row.percentage) }}</small>
              </li>
            }
            @if (sourceRows.length === 0) {
              <li class="empty">No source data available.</li>
            }
          </ul>
        </div>
      </article>

      <article class="report-card">
        <header class="card-header">
          <div>
            <h2>Lost Reason Analysis</h2>
            <p>Top reasons enquiries are lost.</p>
          </div>
          <div class="actions">
            <button type="button" class="ghost" [disabled]="isExporting('lost-reason-analysis', 'csv')" (click)="exportSection('lost-reason-analysis', 'csv')">Export CSV</button>
            <button type="button" class="ghost" [disabled]="isExporting('lost-reason-analysis', 'pdf')" (click)="exportSection('lost-reason-analysis', 'pdf')">Export PDF</button>
            <button type="button" class="ghost" (click)="openScheduleDialog('lost-reason-analysis')">Schedule</button>
            @if (getActiveScheduleCount('lost-reason-analysis') > 0) {
              <span class="schedule-badge">{{ getScheduleBadge('lost-reason-analysis') }}</span>
            }
          </div>
        </header>

        <div class="chart-panel">
          <div class="chart-heading">Lost Reasons (Bar Chart)</div>
          <div class="horizontal-bar-chart" role="img" aria-label="Lost reason distribution">
          @for (row of lostRows; track row.reason) {
            <div class="chart-item">
              <span>{{ row.reason }}</span>
              <div class="track">
                <span class="fill warning" [style.width.%]="lostCountMax > 0 ? (row.count / lostCountMax) * 100 : 0"></span>
              </div>
              <em>{{ row.count }} ({{ formatPercent(row.percentage) }})</em>
            </div>
          }
          @if (lostRows.length === 0) {
            <p class="empty">No lost enquiry reasons in this period.</p>
          }
          </div>
        </div>
      </article>
    </section>
  }

  @if (scheduleDialogOpen) {
    <div class="schedule-modal-backdrop" (click)="closeScheduleDialog()">
      <div class="schedule-modal" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
        <header>
          <div>
            <h3>Schedule {{ scheduleDialogReportKey ? getReportTitle(scheduleDialogReportKey) : 'Report' }}</h3>
            <p>{{ getScheduleFilterSummary() }}</p>
          </div>
          <button type="button" class="icon-btn" (click)="closeScheduleDialog()">✕</button>
        </header>

        @if (scheduleDialogError) {
          <p class="modal-state error">{{ scheduleDialogError }}</p>
        }
        @if (scheduleDialogSuccess) {
          <p class="modal-state success">{{ scheduleDialogSuccess }}</p>
        }

        <div class="modal-form-grid">
          <label>
            Frequency
            <select [(ngModel)]="scheduleFrequency">
              @for (frequency of reportScheduleFrequencyOptions; track frequency) {
                <option [value]="frequency">{{ frequency }}</option>
              }
            </select>
          </label>

          @if (scheduleFrequency === 'weekly') {
            <label>
              Day of Week
              <select [(ngModel)]="scheduleDayOfWeek">
                @for (day of reportScheduleDayOptions; track day.value) {
                  <option [ngValue]="day.value">{{ day.label }}</option>
                }
              </select>
            </label>
          }

          @if (scheduleFrequency === 'monthly') {
            <label>
              Day of Month
              <input type="number" min="1" max="31" [(ngModel)]="scheduleDayOfMonth" />
            </label>
          }

          <label>
            Time (UTC)
            <input type="time" [(ngModel)]="scheduleTimeOfDay" />
          </label>

          <label>
            Format
            <select [(ngModel)]="scheduleFormat">
              @for (format of reportScheduleFormatOptions; track format) {
                <option [value]="format">{{ format }}</option>
              }
            </select>
          </label>
        </div>

        <section class="recipient-section">
          <label>
            Recipients
            <div class="recipient-input-row">
              <input
                type="email"
                placeholder="name@venue.co.uk"
                [(ngModel)]="scheduleRecipientDraft"
                (keydown)="onScheduleRecipientKeydown($event)" />
              <button type="button" class="ghost" (click)="addScheduleRecipientFromDraft()">Add</button>
            </div>
          </label>
          <div class="recipient-chips">
            @for (email of scheduleRecipients; track email) {
              <span class="recipient-chip">
                {{ email }}
                <button type="button" (click)="removeScheduleRecipient(email)">×</button>
              </span>
            }
            @if (scheduleRecipients.length === 0) {
              <p class="empty">No recipients added yet.</p>
            }
          </div>
        </section>

        <label class="checkbox-row">
          <input type="checkbox" [(ngModel)]="scheduleIsActive" />
          Active schedule
        </label>

        <footer>
          <button type="button" class="ghost" (click)="closeScheduleDialog()">Cancel</button>
          <button type="button" class="primary" [disabled]="scheduleDialogSaving" (click)="saveSchedule()">
            {{ scheduleDialogSaving ? 'Saving...' : 'Save Schedule' }}
          </button>
        </footer>
      </div>
    </div>
  }
</section>
