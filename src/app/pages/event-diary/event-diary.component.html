<section class="diary-page">
  <header class="title-block">
    <h1>Event Diary</h1>
    <p>Manage your venue bookings and proposals efficiently.</p>
  </header>

  @if (loadError) {
    <p class="error-banner">{{ loadError }}</p>
  }

  <section class="calendar-card">
    <div class="calendar-toolbar">
      <div class="month-nav">
        <h2>{{ currentRangeLabel }}</h2>
        <div class="month-arrows">
          <button type="button" (click)="shiftMonth(-1)" aria-label="Previous range">&#10094;</button>
          <button type="button" (click)="shiftMonth(1)" aria-label="Next range">&#10095;</button>
        </div>
        <button type="button" class="today-btn" (click)="goToToday()">Today</button>
      </div>

      <div class="toolbar-right">
        <div class="view-toggle" role="tablist" aria-label="Diary view">
          @for (view of diaryViews; track view.key) {
            <button
              type="button"
              role="tab"
              [attr.aria-selected]="selectedView === view.key"
              [class.active]="selectedView === view.key"
              (click)="switchView(view.key)">
              {{ view.label }}
            </button>
          }
        </div>

        <div class="legend-inline">
          <span><i class="legend-chip status-confirmed"></i> Confirmed</span>
          <span><i class="legend-chip status-provisional"></i> Provisional</span>
          <span><i class="legend-chip status-tentative"></i> New / Tentative</span>
          <span><i class="legend-chip status-open-proposal"></i> Open Proposal</span>
          <span><i class="legend-chip status-appointment"></i> Appointment</span>
          <span><i class="legend-chip status-venue-event"></i> Venue Event</span>
        </div>
        <button type="button" class="add-event-btn" (click)="addEvent()">+ Add Event</button>
      </div>
    </div>

    @if (selectedView === 'month') {
      <div class="calendar-grid-wrap">
        <div class="weekdays-row">
          @for (weekday of weekdayLabels; track weekday) {
            <div>{{ weekday }}</div>
          }
        </div>

        <div class="month-grid">
          @for (cell of cells; track cell.key) {
            <article
              class="day-cell"
              [class.outside-month]="!cell.inCurrentMonth"
              (dragover)="$event.preventDefault()"
              (drop)="onDropDay(cell.key)">
              <header class="day-header">
                <span class="day-number">{{ cell.dayNumber }}</span>
                @if (cell.events.length > 0) {
                  <span class="event-count">{{ cell.events.length }} {{ cell.events.length === 1 ? 'event' : 'events' }}</span>
                }
              </header>

              <div class="event-list">
                @for (event of eventsForDisplay(cell); track eventKey(event)) {
                  <div class="event-chip-wrap">
                    <button
                      type="button"
                      class="event-chip"
                      [ngClass]="eventChipClass(event)"
                      [attr.draggable]="canDrag(event)"
                      (dragstart)="onDragStart(event, $event)"
                      (dragend)="onDragEnd()"
                      (mouseenter)="hoveredEventKey = eventKey(event)"
                      (mouseleave)="hoveredEventKey = null"
                      (click)="openDetails(event)">
                      {{ eventDisplayLabel(event) }}
                    </button>

                    @if (hoveredEventKey === eventKey(event)) {
                      <div class="event-popover">
                        <strong>{{ event.label }}</strong>
                        <span><b>Covers:</b> {{ event.covers || '-' }}</span>
                        <span><b>Timing:</b> {{ event.startUtc | date: 'HH:mm' }}-{{ event.endUtc | date: 'HH:mm' }}</span>
                        <span><b>Event style:</b> {{ event.eventStyle || '-' }}</span>
                        <span><b>Status:</b> {{ event.statusKey || event.enquiryStatus || event.eventType }}</span>
                        <span><b>Space:</b> {{ event.spaceName }}</span>
                        <span><b>Event manager:</b> {{ event.eventManagerName || '-' }}</span>
                      </div>
                    }
                  </div>
                }

                @if (hiddenEventsCount(cell) > 0) {
                  <span class="more-events">+{{ hiddenEventsCount(cell) }} more</span>
                }
              </div>
            </article>
          }
        </div>
      </div>
    } @else if (selectedView === 'timeline') {
      <div class="timeline-wrap">
        <p class="timeline-hint">
          Timeline view: six months shown down the left, aligned by the first Monday of each month.
        </p>

        <div class="timeline-table">
          <div class="timeline-header-row">
            <div class="timeline-month-col">Month</div>
            @for (label of timelineHeaderLabels; track $index) {
              <div class="timeline-day-col">{{ label }}</div>
            }
          </div>

          @for (row of timelineRows; track row.monthKey) {
            <div class="timeline-row">
              <div class="timeline-month-cell">
                <strong>{{ row.monthLabel }}</strong>
                <small>1st Mon: {{ row.firstMondayDay }}</small>
              </div>

              @for (cell of row.cells; track cell.key) {
                <article
                  class="timeline-cell"
                  [class.empty]="!cell.isoDate"
                  [class.first-monday]="cell.isFirstMonday"
                  (dragover)="$event.preventDefault()"
                  (drop)="onDropTimelineCell(cell)">
                  @if (cell.dayNumber) {
                    <span class="timeline-day-number">{{ cell.dayNumber }}</span>
                  }

                  <div class="timeline-events">
                    @for (event of eventsForDisplay(cell); track eventKey(event)) {
                      <div class="event-chip-wrap">
                        <button
                          type="button"
                          class="event-chip"
                          [ngClass]="eventChipClass(event)"
                          [attr.draggable]="canDrag(event)"
                          (dragstart)="onDragStart(event, $event)"
                          (dragend)="onDragEnd()"
                          (mouseenter)="hoveredEventKey = eventKey(event)"
                          (mouseleave)="hoveredEventKey = null"
                          (click)="openDetails(event)">
                          {{ eventDisplayLabel(event) }}
                        </button>

                        @if (hoveredEventKey === eventKey(event)) {
                          <div class="event-popover">
                            <strong>{{ event.label }}</strong>
                            <span><b>Covers:</b> {{ event.covers || '-' }}</span>
                            <span><b>Timing:</b> {{ event.startUtc | date: 'HH:mm' }}-{{ event.endUtc | date: 'HH:mm' }}</span>
                            <span><b>Event style:</b> {{ event.eventStyle || '-' }}</span>
                            <span><b>Status:</b> {{ event.statusKey || event.enquiryStatus || event.eventType }}</span>
                            <span><b>Space:</b> {{ event.spaceName }}</span>
                            <span><b>Event manager:</b> {{ event.eventManagerName || '-' }}</span>
                          </div>
                        }
                      </div>
                    }

                    @if (hiddenEventsCount(cell) > 0) {
                      <span class="more-events">+{{ hiddenEventsCount(cell) }} more</span>
                    }
                  </div>
                </article>
              }
            </div>
          }
        </div>
      </div>
    } @else if (selectedView === 'week') {
      <div class="week-wrap">
        <div class="week-grid">
          <aside class="week-time-axis">
            <div class="week-time-head">Time</div>
            @for (hour of timeAxisHours; track hour) {
              <div class="week-time-cell">{{ formatHour(hour) }}</div>
            }
          </aside>

          <div class="week-days-grid">
            @for (day of weekColumns; track day.isoDate) {
              <section class="week-day-column">
                <header class="week-day-header">
                  <strong>{{ day.label }}</strong>
                  <span>{{ day.subLabel }}</span>
                </header>

                <div
                  class="week-day-body"
                  #weekColumn
                  (dragover)="$event.preventDefault()"
                  (drop)="onDropWeekColumn(day.isoDate, $event, weekColumn)">
                  @for (hour of timeSlotHours; track hour) {
                    <div class="week-hour-line" [style.top.%]="timeMarkerPercent(hour)"></div>
                  }

                  @for (event of day.events; track eventKey(event)) {
                    <article
                      class="week-event-block"
                      [ngClass]="eventChipClass(event)"
                      [style.top.%]="weekEventTopPercent(event)"
                      [style.height.%]="weekEventHeightPercent(event)"
                      [attr.draggable]="canDrag(event)"
                      (dragstart)="onDragStart(event, $event)"
                      (dragend)="onDragEnd()"
                      (click)="openDetails(event)">
                      <button
                        type="button"
                        class="resize-handle top"
                        (mousedown)="onResizeHandleMouseDown($event, event, 'start', 'week', weekColumn)">
                      </button>
                      <div class="week-event-content">
                        <strong>{{ eventDisplayLabel(event) }}</strong>
                        <span>{{ event.startUtc | date: 'HH:mm' }} - {{ event.endUtc | date: 'HH:mm' }}</span>
                        <span>{{ event.spaceName }}</span>
                      </div>
                      <button
                        type="button"
                        class="resize-handle bottom"
                        (mousedown)="onResizeHandleMouseDown($event, event, 'end', 'week', weekColumn)">
                      </button>
                    </article>
                  }
                </div>
              </section>
            }
          </div>
        </div>
      </div>
    } @else {
      <div class="day-wrap">
        <div class="day-time-header">
          @for (hour of timeAxisHours; track hour) {
            <span>{{ formatHour(hour) }}</span>
          }
        </div>

        <div class="day-events-stack">
          @for (event of dayEvents; track eventKey(event)) {
            <article class="day-event-row">
              <div class="day-event-details">
                <strong>{{ eventDisplayLabel(event) }}</strong>
                <span>{{ event.spaceName }} · {{ event.startUtc | date: 'HH:mm' }}-{{ event.endUtc | date: 'HH:mm' }}</span>
                <span>{{ event.eventStyle || 'No style' }} · {{ event.covers || '-' }} covers</span>
              </div>

              <div
                class="day-event-track"
                #dayTrack
                (dragover)="$event.preventDefault()"
                (drop)="onDropDayTrack($event, dayTrack)">
                @for (slot of timeSlotHours; track slot) {
                  <div class="day-slot-marker" [style.left.%]="timeMarkerPercent(slot)"></div>
                }

                <div
                  class="day-event-bar"
                  [ngClass]="eventChipClass(event)"
                  [style.left.%]="dayEventLeftPercent(event)"
                  [style.width.%]="dayEventWidthPercent(event)"
                  [attr.draggable]="canDrag(event)"
                  (dragstart)="onDragStart(event, $event)"
                  (dragend)="onDragEnd()"
                  (click)="openDetails(event)">
                  <button
                    type="button"
                    class="resize-handle left"
                    (mousedown)="onResizeHandleMouseDown($event, event, 'start', 'day', dayTrack)">
                  </button>
                  <div class="day-bar-content">
                    <strong>{{ eventDisplayLabel(event) }}</strong>
                    <span>{{ event.startUtc | date: 'HH:mm' }} - {{ event.endUtc | date: 'HH:mm' }}</span>
                  </div>
                  <button
                    type="button"
                    class="resize-handle right"
                    (mousedown)="onResizeHandleMouseDown($event, event, 'end', 'day', dayTrack)">
                  </button>
                </div>
              </div>
            </article>
          }

          @if (dayEvents.length === 0) {
            <p class="day-empty">No events scheduled for this day.</p>
          }
        </div>
      </div>
    }
  </section>

  @if (hasPendingMove && pendingMove; as move) {
    <div class="move-modal-backdrop" (click)="cancelPendingMove()"></div>
    <section class="move-modal" role="dialog" aria-modal="true" aria-label="Confirm event update">
      <h3>Confirm Event Update</h3>
      <p>{{ move.actionLabel }}</p>
      <div class="move-summary">
        <div>
          <span>Event</span>
          <strong>{{ move.event.label }}</strong>
        </div>
        <div>
          <span>Old</span>
          <strong>{{ move.oldStartUtc | date: 'dd/MM/yyyy HH:mm' }} - {{ move.oldEndUtc | date: 'HH:mm' }}</strong>
        </div>
        <div>
          <span>New</span>
          <strong>{{ move.newStartUtc | date: 'dd/MM/yyyy HH:mm' }} - {{ move.newEndUtc | date: 'HH:mm' }}</strong>
        </div>
      </div>

      <div class="move-modal-actions">
        <button type="button" class="ghost" (click)="cancelPendingMove()" [disabled]="applyingMove">Cancel</button>
        <button type="button" class="primary" (click)="confirmPendingMove()" [disabled]="applyingMove">
          {{ applyingMove ? 'Applying...' : 'Confirm Move' }}
        </button>
      </div>
    </section>
  }
</section>
