<section class="diary-page">
  <header class="title-block">
    <h1>Event Diary</h1>
    <p>Manage your venue bookings and proposals efficiently.</p>
  </header>

  @if (loadError) {
    <p class="error-banner">{{ loadError }}</p>
  }

  <section class="calendar-card">
    <div class="calendar-toolbar">
      <div class="month-nav">
        <h2>{{ currentRangeLabel }}</h2>
        @if (selectedView !== 'operations') {
          <div class="month-arrows">
            <button type="button" (click)="shiftMonth(-1)" aria-label="Previous range">&#10094;</button>
            <button type="button" (click)="shiftMonth(1)" aria-label="Next range">&#10095;</button>
          </div>
          <button type="button" class="today-btn" (click)="goToToday()">Today</button>
        }
      </div>

      <div class="toolbar-right">
        <div class="view-toggle" role="tablist" aria-label="Diary view">
          @for (view of availableDiaryViews; track view.key) {
            <button
              type="button"
              role="tab"
              [attr.aria-selected]="selectedView === view.key"
              [class.active]="selectedView === view.key"
              (click)="switchView(view.key)">
              {{ view.label }}
            </button>
          }
        </div>

        @if (selectedView !== 'operations') {
          <button
            type="button"
            class="heatmap-toggle"
            [class.active]="showDemandHeatmap"
            (click)="toggleDemandHeatmap()">
            Demand Heatmap
          </button>

          <div class="space-filter" (click)="$event.stopPropagation()">
            <label>Filter by Space</label>
            <button type="button" class="space-filter-trigger" (click)="toggleSpaceFilterDropdown()">
              <span>{{ spaceFilterSummaryLabel }}</span>
              <small>{{ selectedSpaceFilterKeys.length === 0 ? 'All Spaces' : selectedSpaceFilterKeys.length + ' selected' }}</small>
            </button>

            @if (showSpaceFilterDropdown) {
              <div class="space-filter-menu">
                <label class="space-filter-item all-spaces">
                  <input
                    type="checkbox"
                    [checked]="selectedSpaceFilterKeys.length === 0"
                    (change)="selectAllSpaces()" />
                  <span>All Spaces</span>
                </label>

                @if (spaceFilterOptions.length === 0) {
                  <p class="space-filter-empty">{{ loadingSpaceFilters ? 'Loading spaces...' : (spaceFilterError || 'No spaces available.') }}</p>
                } @else {
                  <div class="space-filter-group">
                    <h4>Spaces</h4>
                    @for (option of standaloneSpaceFilterOptions; track option.key) {
                      <label class="space-filter-item">
                        <input
                          type="checkbox"
                          [checked]="isSpaceFilterSelected(option.key)"
                          (change)="toggleSpaceFilter(option.key)" />
                        <span>{{ option.label }}</span>
                      </label>
                    }
                  </div>

                  @if (combinationSpaceFilterOptions.length > 0) {
                    <div class="space-filter-group">
                      <h4>Space Combinations</h4>
                      @for (option of combinationSpaceFilterOptions; track option.key) {
                        <label class="space-filter-item">
                          <input
                            type="checkbox"
                            [checked]="isSpaceFilterSelected(option.key)"
                            (change)="toggleSpaceFilter(option.key)" />
                          <span>{{ option.label }}</span>
                        </label>
                      }
                    </div>
                  }
                }
              </div>
            }
          </div>

          <div class="legend-inline">
            <span><i class="legend-chip status-confirmed"></i> Confirmed</span>
            <span><i class="legend-chip status-provisional"></i> Provisional</span>
            <span><i class="legend-chip status-tentative"></i> New / Tentative</span>
            <span><i class="legend-chip status-open-proposal"></i> Open Proposal</span>
            <span><i class="legend-chip status-appointment"></i> Appointment</span>
            <span><i class="legend-chip status-venue-event"></i> Venue Event</span>
          </div>
          <div class="export-actions">
            <button type="button" class="export-btn" [disabled]="!!exportState" (click)="exportDiary('xlsx')">
              {{ isExporting('xlsx') ? 'Exporting Excel...' : 'Download Excel' }}
            </button>
            <button type="button" class="export-btn" [disabled]="!!exportState" (click)="exportDiary('pdf')">
              {{ isExporting('pdf') ? 'Exporting PDF...' : 'Download PDF' }}
            </button>
          </div>
          <button type="button" class="add-task-btn" (click)="openAddTask()">+ Add Task</button>
          <button type="button" class="add-event-btn" (click)="addEvent()">+ Add Event</button>
        }
      </div>
    </div>

    @if (selectedView !== 'operations' && showDemandHeatmap && demandHeatmapMessage) {
      <p class="heatmap-message">{{ demandHeatmapMessage }}</p>
    }

    @if (selectedView === 'month') {
      <div class="calendar-grid-wrap">
        <div class="weekdays-row">
          @for (weekday of weekdayLabels; track weekday) {
            <div>{{ weekday }}</div>
          }
        </div>

        <div class="month-grid">
          @for (cell of cells; track cell.key) {
            <article
              class="day-cell"
              [class.outside-month]="!cell.inCurrentMonth"
              [ngClass]="heatmapClassForDate(cell.key)"
              (dragover)="$event.preventDefault()"
              (drop)="onDropDay(cell.key)">
              <header class="day-header">
                <span class="day-number">{{ cell.dayNumber }}</span>
                @if (eventGroupCount(cell) > 0) {
                  <span class="event-count">{{ eventGroupCount(cell) }} {{ eventGroupCount(cell) === 1 ? 'event' : 'events' }}</span>
                }
                @if (showDemandHeatmap && heatmapLabelForDate(cell.key); as label) {
                  <span class="heatmap-chip">{{ label }}</span>
                }
              </header>

              <div class="event-list">
                @for (group of eventGroupsForDisplay(cell); track group.key) {
                  @if (group.nested) {
                    <article class="event-group nested">
                      <button type="button" class="event-group-parent" (click)="openDetails(group.events[0])">
                        {{ group.parentLabel }}
                      </button>
                      <div class="event-group-children">
                        @for (event of group.events; track eventKey(event)) {
                          <div class="event-chip-wrap">
                            <button
                              type="button"
                              class="event-chip sub-event-child"
                              [ngClass]="eventChipClass(event)"
                              cdkOverlayOrigin
                              #nestedMonthEventOrigin="cdkOverlayOrigin"
                              [attr.draggable]="canDrag(event)"
                              (dragstart)="onDragStart(event, $event)"
                              (dragend)="onDragEnd()"
                              (mouseenter)="onEventMouseEnter(event, nestedMonthEventOrigin, parentEventLabel(event) + ' · ' + eventDisplayLabel(event))"
                              (mouseleave)="onEventMouseLeave()"
                              (click)="openDetails(event)">
                              {{ eventDisplayLabel(event) }}
                            </button>
                          </div>
                        }
                      </div>
                    </article>
                  } @else {
                    <div class="event-chip-wrap">
                      <button
                        type="button"
                        class="event-chip"
                        [ngClass]="eventChipClass(group.events[0])"
                        cdkOverlayOrigin
                        #singleMonthEventOrigin="cdkOverlayOrigin"
                        [attr.draggable]="canDrag(group.events[0])"
                        (dragstart)="onDragStart(group.events[0], $event)"
                        (dragend)="onDragEnd()"
                        (mouseenter)="onEventMouseEnter(group.events[0], singleMonthEventOrigin)"
                        (mouseleave)="onEventMouseLeave()"
                        (click)="openDetails(group.events[0])">
                        {{ eventDisplayLabel(group.events[0]) }}
                      </button>
                    </div>
                  }
                }

                @if (hiddenEventGroupsCount(cell) > 0) {
                  <span class="more-events">+{{ hiddenEventGroupsCount(cell) }} more</span>
                }
              </div>
            </article>
          }
        </div>
      </div>
    } @else if (selectedView === 'timeline') {
      <div class="timeline-wrap">
        <p class="timeline-hint">
          Timeline view: next 12 months shown down the left, aligned by the first Monday of each month.
        </p>

        <div class="timeline-layout-toggle">
          <button type="button" [class.active]="timelineLayout === 'standard'" (click)="setTimelineLayout('standard')">Standard</button>
          <button type="button" [class.active]="timelineLayout === 'room'" (click)="setTimelineLayout('room')">Room View</button>
        </div>

        @if (timelineLayout === 'standard') {
          <div class="timeline-table">
            <div class="timeline-header-row">
              <div class="timeline-month-col">Month</div>
              @for (label of timelineHeaderLabels; track $index) {
                <div class="timeline-day-col">{{ label }}</div>
              }
            </div>

            @for (row of timelineRows; track row.monthKey) {
              <div class="timeline-row">
                <div class="timeline-month-cell">
                  <strong>{{ row.monthLabel }}</strong>
                  <small>1st Mon: {{ row.firstMondayDay }}</small>
                </div>

                @for (cell of row.cells; track cell.key) {
                  <article
                    class="timeline-cell"
                    [class.empty]="!cell.isoDate"
                    [class.first-monday]="cell.isFirstMonday"
                    [ngClass]="heatmapClassForDate(cell.isoDate)"
                    (dragover)="$event.preventDefault()"
                    (drop)="onDropTimelineCell(cell)">
                    @if (cell.dayNumber) {
                      <span class="timeline-day-number">{{ cell.dayNumber }}</span>
                      @if (showDemandHeatmap && heatmapLabelForDate(cell.isoDate); as label) {
                        <span class="heatmap-chip">{{ label }}</span>
                      }
                    }

                    <div class="timeline-events">
                      @for (group of eventGroupsForDisplay(cell); track group.key) {
                        @if (group.nested) {
                          <article class="event-group nested compact">
                            <button type="button" class="event-group-parent" (click)="openDetails(group.events[0])">
                              {{ group.parentLabel }}
                            </button>
                            <div class="event-group-children">
                              @for (event of group.events; track eventKey(event)) {
                                <div class="event-chip-wrap">
                                  <button
                                    type="button"
                                    class="event-chip sub-event-child"
                                    [ngClass]="eventChipClass(event)"
                                    cdkOverlayOrigin
                                    #nestedTimelineEventOrigin="cdkOverlayOrigin"
                                    [attr.draggable]="canDrag(event)"
                                    (dragstart)="onDragStart(event, $event)"
                                    (dragend)="onDragEnd()"
                                    (mouseenter)="onEventMouseEnter(event, nestedTimelineEventOrigin, parentEventLabel(event) + ' · ' + eventDisplayLabel(event))"
                                    (mouseleave)="onEventMouseLeave()"
                                    (click)="openDetails(event)">
                                    {{ eventDisplayLabel(event) }}
                                  </button>
                                </div>
                              }
                            </div>
                          </article>
                        } @else {
                          <div class="event-chip-wrap">
                            <button
                              type="button"
                              class="event-chip"
                              [ngClass]="eventChipClass(group.events[0])"
                              cdkOverlayOrigin
                              #singleTimelineEventOrigin="cdkOverlayOrigin"
                              [attr.draggable]="canDrag(group.events[0])"
                              (dragstart)="onDragStart(group.events[0], $event)"
                              (dragend)="onDragEnd()"
                              (mouseenter)="onEventMouseEnter(group.events[0], singleTimelineEventOrigin)"
                              (mouseleave)="onEventMouseLeave()"
                              (click)="openDetails(group.events[0])">
                              {{ eventDisplayLabel(group.events[0]) }}
                            </button>
                          </div>
                        }
                      }

                      @if (hiddenEventGroupsCount(cell) > 0) {
                        <span class="more-events">+{{ hiddenEventGroupsCount(cell) }} more</span>
                      }
                    </div>
                  </article>
                }
              </div>
            }
          </div>
        } @else {
          <div class="room-timeline-table">
            <div class="room-timeline-header">
              <div class="room-space-col">Space</div>
              @for (label of timelineHeaderLabels; track $index) {
                <div class="room-day-col">{{ label }}</div>
              }
            </div>

            @for (row of roomTimelineRows; track row.spaceId) {
              <div class="room-timeline-row">
                <div class="room-space-cell">{{ row.spaceName }}</div>
                <div
                  class="room-track"
                  [style.height.px]="roomRowHeightPx(row)"
                  #roomTrack
                  (dragover)="$event.preventDefault()"
                  (drop)="onDropRoomTrack(row, $event, roomTrack)">
                  @for (label of timelineHeaderLabels; track $index) {
                    <span class="room-grid-line" [style.left.%]="timelineColumnPercent($index)"></span>
                  }
                  @for (bar of row.bars; track bar.key) {
                    <button
                      type="button"
                      class="room-event-bar"
                      [ngClass]="eventChipClass(bar.event)"
                      cdkOverlayOrigin
                      #roomTimelineEventOrigin="cdkOverlayOrigin"
                      [style.left.%]="bar.leftPercent"
                      [style.width.%]="bar.widthPercent"
                      [style.top.px]="roomBarTopPx(bar)"
                      [attr.draggable]="canDrag(bar.event)"
                      (dragstart)="onDragStart(bar.event, $event)"
                      (dragend)="onDragEnd()"
                      (mouseenter)="onEventMouseEnter(bar.event, roomTimelineEventOrigin)"
                      (mouseleave)="onEventMouseLeave()"
                      (click)="openDetails(bar.event)">
                      {{ eventDisplayLabel(bar.event) }}
                    </button>
                  }
                  @if (row.bars.length === 0) {
                    <small class="room-empty">No events</small>
                  }
                </div>
              </div>
            }

            @if (roomTimelineRows.length === 0) {
              <p class="room-empty-state">No spaces available for the selected filter.</p>
            }
          </div>
        }
      </div>
    } @else if (selectedView === 'week') {
      <div class="week-wrap">
        <div class="week-layout-toggle">
          <button type="button" [class.active]="weekLayout === 'merged'" (click)="setWeekLayout('merged')">Merged</button>
          <button type="button" [class.active]="weekLayout === 'space'" (click)="setWeekLayout('space')">Space Lanes</button>
        </div>

        @if (weekLayout === 'merged') {
          <div class="week-grid">
            <aside class="week-time-axis">
              <div class="week-time-head">Time</div>
              @for (hour of timeAxisHours; track hour) {
                <div class="week-time-cell">{{ formatHour(hour) }}</div>
              }
            </aside>

            <div class="week-days-grid" cdkDropListGroup>
              @for (day of weekColumns; track day.isoDate) {
                <section class="week-day-column">
                  <header class="week-day-header">
                    <strong>{{ day.label }}</strong>
                    <span>{{ day.subLabel }}</span>
                  </header>

                  <div
                    class="week-day-body"
                    [ngClass]="heatmapClassForDate(day.isoDate)"
                    #weekColumn
                    cdkDropList
                    [cdkDropListData]="day.events"
                    [cdkDropListSortingDisabled]="true"
                    (cdkDropListDropped)="onWeekCdkDrop(day.isoDate, $event, weekColumn)"
                    (dragover)="$event.preventDefault()"
                    (drop)="onDropWeekColumn(day.isoDate, $event, weekColumn)">
                    @for (hour of timeSlotHours; track hour) {
                      <div class="week-hour-line" [style.top.%]="timeMarkerPercent(hour)"></div>
                    }

                    @for (event of day.events; track eventKey(event)) {
                      <article
                        class="week-event-block"
                        [ngClass]="eventChipClass(event)"
                        cdkDrag
                        [cdkDragData]="event"
                        cdkOverlayOrigin
                        #weekEventOrigin="cdkOverlayOrigin"
                        [style.top.%]="weekEventTopPercent(event)"
                        [style.height.%]="weekEventHeightPercent(event)"
                        (mouseenter)="onEventMouseEnter(event, weekEventOrigin)"
                        (mouseleave)="onEventMouseLeave()"
                        (click)="openDetails(event)">
                        <button
                          type="button"
                          class="resize-handle top"
                          (mousedown)="onResizeHandleMouseDown($event, event, 'start', 'week', weekColumn)">
                        </button>
                        <div class="week-event-content">
                          <strong>{{ eventDisplayLabel(event) }}</strong>
                          <span>{{ event.startUtc | date: 'HH:mm' }} - {{ event.endUtc | date: 'HH:mm' }}</span>
                          <span>{{ event.spaceName }}</span>
                        </div>
                        <button
                          type="button"
                          class="resize-handle bottom"
                          (mousedown)="onResizeHandleMouseDown($event, event, 'end', 'week', weekColumn)">
                        </button>
                      </article>
                    }
                  </div>
                </section>
              }
            </div>
          </div>
        } @else {
          <div class="week-space-grid" cdkDropListGroup>
            <div class="week-space-header-row">
              <div class="week-space-header-cell">Space</div>
              @for (day of weekColumns; track day.isoDate) {
                <div class="week-space-header-cell day">
                  <strong>{{ day.label }}</strong>
                  <span>{{ day.subLabel }}</span>
                </div>
              }
            </div>

            @for (row of weekSpaceRows; track row.spaceId) {
              <div class="week-space-row">
                <div class="week-space-label">{{ row.spaceName }}</div>
                @for (dayLane of row.days; track dayLane.isoDate) {
                  <div
                    class="week-space-day-body"
                    [ngClass]="heatmapClassForDate(dayLane.isoDate)"
                    #weekSpaceColumn
                    cdkDropList
                    [cdkDropListData]="dayLane.events"
                    [cdkDropListSortingDisabled]="true"
                    (cdkDropListDropped)="onWeekSpaceCdkDrop(dayLane.isoDate, row.spaceId, $event, weekSpaceColumn)"
                    (dragover)="$event.preventDefault()"
                    (drop)="onDropWeekSpaceColumn(dayLane.isoDate, row.spaceId, $event, weekSpaceColumn)">
                    @for (hour of timeSlotHours; track hour) {
                      <div class="week-hour-line" [style.top.%]="timeMarkerPercent(hour)"></div>
                    }

                    @for (event of dayLane.events; track eventKey(event)) {
                      <article
                        class="week-event-block compact"
                        [ngClass]="eventChipClass(event)"
                        cdkDrag
                        [cdkDragData]="event"
                        cdkOverlayOrigin
                        #weekSpaceEventOrigin="cdkOverlayOrigin"
                        [style.top.%]="weekEventTopPercent(event)"
                        [style.height.%]="weekEventHeightPercent(event)"
                        (mouseenter)="onEventMouseEnter(event, weekSpaceEventOrigin)"
                        (mouseleave)="onEventMouseLeave()"
                        (click)="openDetails(event)">
                        <button
                          type="button"
                          class="resize-handle top"
                          (mousedown)="onResizeHandleMouseDown($event, event, 'start', 'week', weekSpaceColumn)">
                        </button>
                        <div class="week-event-content">
                          <strong>{{ eventDisplayLabel(event) }}</strong>
                          <span>{{ event.startUtc | date: 'HH:mm' }} - {{ event.endUtc | date: 'HH:mm' }}</span>
                        </div>
                        <button
                          type="button"
                          class="resize-handle bottom"
                          (mousedown)="onResizeHandleMouseDown($event, event, 'end', 'week', weekSpaceColumn)">
                        </button>
                      </article>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    } @else if (selectedView === 'day') {
      <div class="day-wrap">
        <div class="day-grid">
          <aside class="day-time-axis">
            <div class="day-time-head">Time</div>
            @for (hour of timeAxisHours; track hour) {
              <div class="day-time-cell">{{ formatHour(hour) }}</div>
            }
          </aside>

          <div class="day-space-columns" cdkDropListGroup>
            @for (column of daySpaceColumns; track column.spaceId) {
              <section class="day-space-column">
                <header class="day-space-header">
                  <strong>{{ column.spaceName }}</strong>
                </header>

                <div
                  class="day-space-body"
                  [ngClass]="heatmapClassForDate(currentDayIso)"
                  #daySpaceColumn
                  cdkDropList
                  [cdkDropListData]="column.events"
                  [cdkDropListSortingDisabled]="true"
                  (cdkDropListDropped)="onDaySpaceCdkDrop(currentDayIso, column.spaceId, $event, daySpaceColumn)"
                  (dragover)="$event.preventDefault()"
                  (drop)="onDropDaySpaceColumn(currentDayIso, column.spaceId, $event, daySpaceColumn)">
                  @for (hour of timeSlotHours; track hour) {
                    <div class="week-hour-line" [style.top.%]="timeMarkerPercent(hour)"></div>
                  }

                  @for (event of column.events; track eventKey(event)) {
                    <article
                      class="day-event-bar"
                      [ngClass]="eventChipClass(event)"
                      cdkDrag
                      [cdkDragData]="event"
                      cdkOverlayOrigin
                      #dayEventOrigin="cdkOverlayOrigin"
                      [style.top.%]="dayEventTopPercent(event)"
                      [style.height.%]="dayEventHeightPercent(event)"
                      (mouseenter)="onEventMouseEnter(event, dayEventOrigin)"
                      (mouseleave)="onEventMouseLeave()"
                      (click)="openDetails(event)">
                      <button
                        type="button"
                        class="resize-handle top"
                        (mousedown)="onResizeHandleMouseDown($event, event, 'start', 'day', daySpaceColumn)">
                      </button>
                      <div class="day-bar-content">
                        <strong>{{ eventDisplayLabel(event) }}</strong>
                        <span>{{ event.startUtc | date: 'HH:mm' }} - {{ event.endUtc | date: 'HH:mm' }}</span>
                        <span>{{ event.eventStyle || 'No style' }}</span>
                      </div>
                      <button
                        type="button"
                        class="resize-handle bottom"
                        (mousedown)="onResizeHandleMouseDown($event, event, 'end', 'day', daySpaceColumn)">
                      </button>
                    </article>
                  }
                </div>
              </section>
            }

            @if (daySpaceColumns.length === 0) {
              <p class="day-empty">No spaces available for the selected filter.</p>
            }
          </div>
        </div>

        @if (dayEvents.length === 0) {
          <p class="day-empty">No events scheduled for this day.</p>
        }
      </div>
    } @else {
      <section class="operations-wrap">
        <div class="operations-grid">
          @for (column of operationsColumns; track column.label) {
            <article class="operations-column">
              <header>
                <h3>{{ column.label }}</h3>
                <p>{{ column.date | date: 'EEE dd MMM yyyy' }}</p>
              </header>

              @for (item of column.items; track item.enquiryId + '-' + item.startUtc) {
                <div class="operations-item">
                  <strong>{{ item.eventName }}</strong>
                  <div class="operations-time">{{ item.startUtc | date: 'HH:mm' }} - {{ item.endUtc | date: 'HH:mm' }}</div>
                  <div class="operations-meta">{{ item.spaceName }} · {{ item.covers }} covers</div>
                  <div class="operations-meta">{{ item.eventStyle || 'No style set' }}</div>
                  @if (item.setupRequirements) {
                    <div class="operations-meta">{{ item.setupRequirements }}</div>
                  }
                </div>
              }

              @if (column.items.length === 0) {
                <p class="operations-empty">No scheduled events.</p>
              }
            </article>
          }
        </div>
        @if (operationsColumns.length === 0) {
          <p class="operations-empty">No operations data available for this venue.</p>
        }
      </section>
    }
  </section>

  @if (activePopoverOrigin; as popoverOrigin) {
    <ng-template
      cdkConnectedOverlay
      [cdkConnectedOverlayOpen]="popoverOpen && !!activePopoverEvent"
      [cdkConnectedOverlayOrigin]="popoverOrigin"
      [cdkConnectedOverlayOffsetY]="8"
      [cdkConnectedOverlayPush]="true"
      [cdkConnectedOverlayFlexibleDimensions]="false">
      <div class="diary-popover-overlay" (mouseenter)="onPopoverMouseEnter()" (mouseleave)="onPopoverMouseLeave()">
        @if (activePopoverEvent) {
          <app-diary-event-popover
            [event]="activePopoverEvent"
            [headline]="activePopoverHeadline || undefined"
            [expanded]="popoverExpanded"
            (toggleExpanded)="onPopoverToggleExpanded()"
            (viewDetails)="onPopoverViewDetails()">
          </app-diary-event-popover>
        }
      </div>
    </ng-template>
  }

  @if (hasPendingMove && pendingMove; as move) {
    <div class="move-modal-backdrop" (click)="cancelPendingMove()"></div>
    <section class="move-modal" role="dialog" aria-modal="true" aria-label="Confirm event update">
      <h3>Confirm Event Update</h3>
      <p>{{ move.actionLabel }}</p>
      <div class="move-summary">
        <div>
          <span>Event</span>
          <strong>{{ move.event.label }}</strong>
        </div>
        <div>
          <span>Old</span>
          <strong>{{ move.oldStartUtc | date: 'dd/MM/yyyy HH:mm' }} - {{ move.oldEndUtc | date: 'HH:mm' }}</strong>
        </div>
        <div>
          <span>New</span>
          <strong>{{ move.newStartUtc | date: 'dd/MM/yyyy HH:mm' }} - {{ move.newEndUtc | date: 'HH:mm' }}</strong>
        </div>
      </div>

      @if (move.checkingConflicts) {
        <p class="move-conflict-info checking">Checking for space conflicts...</p>
      } @else if (move.conflicts.length === 0) {
        <p class="move-conflict-info clear">{{ move.conflictCheckMessage }}</p>
      } @else {
        <div class="move-conflicts">
          <p>{{ move.conflictCheckMessage }}</p>
          <ul>
            @for (conflict of move.conflicts; track conflict.type + '-' + conflict.id) {
              <li>
                <strong>{{ conflict.label }}</strong>
                <span class="severity-tag" [class.hard]="(conflict.severity || '').toLowerCase() === 'hard'" [class.soft]="(conflict.severity || '').toLowerCase() !== 'hard'">
                  {{ conflict.severity || 'Soft' }}
                </span>
                <span>{{ conflict.startUtc | date: 'dd/MM HH:mm' }} - {{ conflict.endUtc | date: 'dd/MM HH:mm' }}</span>
                @if (conflict.spaceName) {
                  <span>Space: {{ conflict.spaceName }}</span>
                }
                @if (conflict.description) {
                  <span>{{ conflict.description }}</span>
                }
              </li>
            }
          </ul>
        </div>
      }

      @if (hasSuggestedAlternatives) {
        <div class="move-alternatives">
          <p>Suggested alternatives</p>
          <ul>
            @for (alternative of move.alternatives; track alternative.spaceId + '-' + alternative.startUtc) {
              <li>
                <div>
                  <strong>{{ alternative.spaceName }}</strong>
                  <span>{{ alternative.startUtc | date: 'dd/MM HH:mm' }} - {{ alternative.endUtc | date: 'HH:mm' }}</span>
                  <small>{{ alternative.reason }}</small>
                </div>
                <button type="button" (click)="applySuggestedAlternative(alternative)" [disabled]="applyingMove">Choose</button>
              </li>
            }
          </ul>
        </div>
      }

      <div class="move-modal-actions">
        <button type="button" class="ghost" (click)="cancelPendingMove()" [disabled]="applyingMove">Cancel</button>
        @if (canProceedSoftConflicts) {
          <button type="button" class="warning" (click)="proceedPendingMoveWithSoftConflicts()" [disabled]="applyingMove">
            {{ applyingMove ? 'Applying...' : 'Proceed anyway' }}
          </button>
        }
        <button type="button" class="primary" (click)="confirmPendingMove()" [disabled]="!canConfirmPendingMove">
          {{ applyingMove ? 'Applying...' : 'Confirm Move' }}
        </button>
      </div>
    </section>
  }

  @if (moveUndoState; as undo) {
    <section class="move-undo-toast" role="status" aria-live="polite">
      <div class="move-undo-text">
        <strong>{{ undo.eventLabel }} moved.</strong>
        <span>Undo available for {{ undo.secondsRemaining }}s.</span>
      </div>
      <button type="button" class="undo-btn" (click)="undoLastMove()" [disabled]="undo.undoing">
        {{ undo.undoing ? 'Undoing...' : 'Undo' }}
      </button>
    </section>
  }
</section>

<app-task-quick-create-modal
  [isOpen]="showAddTaskModal"
  [defaultEnquiryId]="null"
  (close)="closeAddTaskModal()"
  (created)="onTaskQuickCreated($event)">
</app-task-quick-create-modal>
